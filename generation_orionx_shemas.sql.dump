-- Проверка результатов
-- SELECT CUUID, CName, CText1, CConcept FROM dde_ConceptX WHERE CConcept = 2400 AND (CName = 'address'
--                                       OR CName = 'version' OR CName = 'd_index' OR CName = 'description'
--                                       OR CName = 'priority' OR CName = 'contactId_zone' OR CName = 'time_window');
-- SELECT dde_ConceptX.CUUID from dde_ConceptX WHERE CConcept IN (SELECT CFConceptExt FROM dde_ConfigX WHERE CFConceptExt >= 5000 AND CFConceptExt < 50000);
-- SELECT CFConceptExt FROM dde_ConfigX WHERE CFConceptExt > 5000 AND CFConcept < 50000;
SELECT count(CUUID) FROM dde_ConceptX WHERE CConcept = 3600;
SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2600 AND CName = 'Не управлять'
-- IF (SELECT count(dde_SetX.SUUID) FROM dde_SetX WHERE SConcept = 2000400 AND SOwner = '00000000-0000-0000-0000-000000005101') <= 0
--     print 'not exists';
SELECT distinct SConcept FROM dde_SetX;
GO
/*
    1. генерация наборов параметров для приборов, индентификаторами являются значения CName из ConceptX
    2. генерация наборов входов
    + TODO: сгенерировать 144 набора для всех типов входов
    + TODO: сгенерировать концепт "Тактики"
    + TODO: сгенерировать набор для типов входов
    + TODO: сгенерировать наборы приборов со входами (условие количества входов - тип прибора), дефолтный тип входа - у каждого прибора свой
    + TODO: сгенерировать наборы приборов с выходами (разница в типах выходов)
    TODO: сгенерировать наборы считывателей (уточнить ТИП считывателя)
    TODO: проверка на наличие записей наборов (типов входов, типов выходов, считывателей, типов приборов), каждый запуск должен только добавлять из ConceptX

    -- тактика - отдельный концепт
    -- задержка управления реле (relay_control_delay), время управления реле(relay_control_time) (выход): тип float, значение кратно 0,125 мс, в АБД значения округляются
 */

/* задаем общие переменные генерации */
-- DELETE FROM dde_SetX WHERE SConcept = 2000100
-- DELETE FROM dde_SetX WHERE SConcept = 2000200
-- DELETE FROM dde_SetX WHERE SConcept = 2000300

DECLARE @insertable bit = 0;
DECLARE @CUUID1 uniqueidentifier;
DECLARE @CUUID2 uniqueidentifier;
DECLARE @CUUID3 uniqueidentifier = NULL;
DECLARE @CName nvarchar(MAX);
DECLARE @CText1 nvarchar(MAX);

/* Генерация концепта Тактики (2800) */
-- INSERT INTO dde_ConfigX(CFUUID, CFConcept, CFConceptExt, CFName) VALUES ('00000000-0000-0000-0000-000000002800', 1, 2800, 'Тактики');

DECLARE @Concept_enters_params bigint = 2500; -- концепт для набора входов прибора, по умолчанию - охранный
DECLARE @Concept_enters bigint = 3600; -- концепт для набора входов прибора, по умолчанию - охранный
DECLARE @Concept_readers bigint = 3800; -- концепт для набора входов прибора, по умолчанию - охранный
DECLARE @Concept_reader_params bigint = 2700; -- концепт для набора входов прибора, по умолчанию - охранный
DECLARE @SConcept_EntersParams_sets bigint  = 20000600;
DECLARE @SConcept_RelayParams_sets bigint   = 20000700;
DECLARE @SConcept_ReadersParams_sets bigint = 20000800;
DECLARE @SConcept_DevicesParams_sets bigint = 20000400;
DECLARE @SConcept_EventsDevice_sets bigint = 20000900;



-- ГЕНЕРАЦИЯ ТИПОВ ВХОДА (3600) --
DECLARE enters_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_enters;
DECLARE @CUUID_enter_type_owner uniqueidentifier;
OPEN enters_cursor;
FETCH NEXT FROM enters_cursor INTO @CUUID_enter_type_owner, @CName, @CText1;
WHILE @@FETCH_STATUS = 0
    BEGIN
       --ГЕНЕРАЦИЯ  НАБОРА ПАРАМЕТРОВ ДЛЯ КАЖДОГО ТИПА ВХОДА --
        DECLARE params_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_enters_params
        OPEN params_cursor;
        FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                IF @CName = 'device_address' OR @CName = 'number' OR @CName = 'user_number' OR @CName = 'contactId_zone'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'int');
                    --print @CUUID2;
                    END
                IF @CName = 'name' OR @CName = 'description' OR @CName = 'type'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                    END
                 IF @CName = 'statistic_summary' OR @CName = 'zone_day'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'bool');
                    END
               -- IF (SELECT count(dde_SetX.SUUID) FROM dde_SetX WHERE SConcept = 2000600 AND  SOwner = @CUUID_enter_type_owner) <= 0
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                        VALUES (NEWID(), @SConcept_EntersParams_sets, @CUUID_enter_type_owner, @CName, @CUUID1, @CUUID2, NULL, NULL, @CText1);

                --print @CUUID1;
            FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
            END
            close params_cursor;
            DEALLOCATE params_cursor;
       FETCH NEXT FROM enters_cursor INTO @CUUID_enter_type_owner, @CName, @CText1;
   END
CLOSE enters_cursor;
deallocate enters_cursor;


-- ГЕНЕРАЦИЯ ТИПОВ Считывателя (3800) --
DECLARE enters_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_readers;
DECLARE @CUUID_reader_type_owner uniqueidentifier;
OPEN enters_cursor;
FETCH NEXT FROM enters_cursor INTO @CUUID_reader_type_owner, @CName, @CText1;
WHILE @@FETCH_STATUS = 0
    BEGIN
       --ГЕНЕРАЦИЯ  НАБОРА ПАРАМЕТРОВ ДЛЯ КАЖДОГО ТИПА ВХОДА --
        DECLARE params_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_reader_params
        OPEN params_cursor;
        FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                IF @CName = 'device_address' OR @CName = 'number' OR @CName = 'user_number' OR @CName = 'contactId_zone'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'int');
                    --print @CUUID2;
                    END
                IF @CName = 'name' OR @CName = 'description' OR @CName = 'type'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                    END
                 IF @CName = 'all_zones' OR @CName = 'all_group_zones'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'bool');
                    END
               -- IF (SELECT count(dde_SetX.SUUID) FROM dde_SetX WHERE SConcept = 2000600 AND  SOwner = @CUUID_enter_type_owner) <= 0
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                        VALUES (NEWID(), @SConcept_ReadersParams_sets, @CUUID_reader_type_owner, @CName, @CUUID1, @CUUID2, NULL, NULL, @CText1);

                --print @CUUID1;
            FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
            END
            close params_cursor;
            DEALLOCATE params_cursor;
       FETCH NEXT FROM enters_cursor INTO @CUUID_reader_type_owner, @CName, @CText1;
   END
CLOSE enters_cursor;
deallocate enters_cursor;


-- ГЕНЕРАЦИЯ ТИПОВ ВЫХОДОВ (3700) --
SET @Concept_enters = 3700;
SET @Concept_enters_params = 2600;
DECLARE enters_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_enters;
--DECLARE @CUUID_enter_type_owner uniqueidentifier;

OPEN enters_cursor;
FETCH NEXT FROM enters_cursor INTO @CUUID_enter_type_owner, @CName, @CText1;
WHILE @@FETCH_STATUS = 0
    BEGIN
        --ГЕНЕРАЦИЯ  НАБОРА ПАРАМЕТРОВ ДЛЯ КАЖДОГО ТИПА ВЫХОДА --
        DECLARE params_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_enters_params
        OPEN params_cursor;
        FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                IF @CName = 'device_address' OR @CName = 'number' OR @CName = 'user_number' OR @CName = 'contactId_zone'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'int');
                    --print @CUUID2;
                    END
                IF @CName = 'name' OR @CName = 'description' OR @CName = 'type'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                    END
                 IF @CName = 'central_control_tactic' OR @CName = 'zone_day'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'bool');
                    END
                IF @CName = 'relay_control_delay' OR @CName = 'relay_control_time'
                    BEGIN
                        SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'float');
                    END
                IF @CName = 'tactic'
                    BEGIN
                         SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                         -- SET @CUUID3 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2800 AND CName = 'Не управлять');
                    END
               -- IF (SELECT count(dde_SetX.SUUID) FROM dde_SetX WHERE SConcept = 2000600 AND  SOwner = @CUUID_enter_type_owner) <= 0
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                        VALUES (NEWID(), @SConcept_RelayParams_sets, @CUUID_enter_type_owner, @CName, @CUUID1, @CUUID2, @CUUID3, NULL, @CText1);
                SET @CUUID3 = NULL;
                --print @CUUID1;
            FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
            END
            close params_cursor;
            DEALLOCATE params_cursor;
       FETCH NEXT FROM enters_cursor INTO @CUUID_enter_type_owner, @CName, @CText1;
    END
CLOSE enters_cursor;
deallocate enters_cursor;

-- ГЕНЕРАЦИЯ ТИПОВ ПРИБОРОВ --
DECLARE @CUUID_device_owner uniqueidentifier;
DECLARE @CDeviceName nvarchar(MAX);
DECLARE @CConcept_device bigint;
DECLARE @Concept_device_params bigint = 2400; -- концепт для набора параметров прибора
DECLARE cuuid_cursor cursor FOR SELECT CUUID, CConcept, CName FROM dde_ConceptX WHERE CConcept IN (SELECT CFConceptExt FROM dde_ConfigX WHERE CFConceptExt BETWEEN 5000 AND 50000);

OPEN cuuid_cursor;
FETCH NEXT FROM cuuid_cursor INTO @CUUID_device_owner, @CConcept_device, @CDeviceName;
WHILE @@FETCH_STATUS = 0
   BEGIN
        /* ГЕНЕРАЦИЯ  НАБОРА ПАРАМЕТРОВ В ЗАВИСИМОСТИ ОТ ТИПА ПРИБОРА */
        -- набор параметров в зависимости от типа прибора, надо придумать условие:
        -- если CConcept = 10000, то ВСЕ + включаем параметр окно_времени
             -- если CConcept = 15000, то ВСЕ + включаем параметр окно_времени + параметр группы_доступа
        -- если CConcept = 13000 или 23000 или ..., то ВСЕ + включаем параметр трансляция
        -- если CConcept = 80000, то ВСЕ + включаем параметр подключенные_кпб
   DECLARE params_cursor cursor FOR SELECT CUUID, CName, CText1 FROM dde_ConceptX WHERE CConcept = @Concept_device_params AND (
            CName = 'address' OR CName = 'name'
            OR CName = 'version' OR CName = 'd_index' OR CName = 'description'
            OR CName = 'priority' OR CName = 'contactId_zone'
                OR CName =
                     CASE
                         WHEN @CConcept_device = 10000 THEN 'time_window'
                         WHEN @CConcept_device = 15000 THEN 'access_groups'
                         WHEN     @CConcept_device = 13000
                                 OR @CConcept_device = 11000
                                 OR @CConcept_device = 20000
                                 OR @CConcept_device = 22000
                                 OR @CConcept_device = 23000
                         THEN 'broadcasting'
                     END
                OR CName =
                   CASE
                       WHEN @CConcept_device = 15000 THEN 'time_window'
                    END
        )
    OPEN params_cursor;
    FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            -- print @CName;
            IF @CName = 'address' OR @CName = 'version' OR @CName = 'd_index' OR @CName = 'contactId_zone'
                BEGIN
                    SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'int');
                    --print @CUUID2;
                END
            IF @CName = 'name' OR @CName = 'description'
                BEGIN
                    SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                END
            IF @CName = 'priority'
                BEGIN
                    SET @CUUID2 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 2000 AND CName = 'nvarchar');
                    SET @CUUID3 = (SELECT dde_ConceptX.CUUID FROM dde_ConceptX WHERE CConcept = 3500 AND CName = 'По умолчанию');
                END
           -- ELSE
            -- print @CText1;
           -- IF (SELECT count(dde_SetX.SUUID) FROM dde_SetX WHERE SConcept = 2000400 AND  SOwner = @CUUID_device_owner) <= 0
            IF(@insertable = 1)
                INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                    VALUES (NEWID(), @SConcept_DevicesParams_sets, @CUUID_device_owner, @CName, @CUUID1, @CUUID2, @CUUID3, NULL, @CText1);
            SET @CUUID3 = NULL;
            FETCH NEXT FROM params_cursor INTO @CUUID1, @CName, @CText1;
        END
    close params_cursor;
    DEALLOCATE params_cursor;

        /*
        TODO: сделать генерация наборов входов, выходов, считывателей процедурой
        на вход процедура принимает концепты наборов и концепты типов
        */
    /*
     TODO: Сгенерировать набор входов для приборов различных по типу; разные типы дефолтных входов ("выходное напряжение", "охранный" etc)
     */
    -- входы приборов пока берем из первичной(-ых) таблицы
    DECLARE @EName nvarchar(MAX);
    DECLARE @DName nvarchar(MAX);
    DECLARE @DVersion int;
    DECLARE enters_cursor cursor FOR SELECT EName, DName, DVersion FROM export_enters WHERE DName = @CDeviceName;
        OPEN enters_cursor;
        FETCH NEXT FROM enters_cursor INTO @EName, @DName, @DVersion;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                print @DName;
                SET @CUUID1 = (SELECT CUUID FROM dde_ConceptX WHERE CConcept = 3600 AND CName = @EName);
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                            VALUES (NEWID(), 20000100, @CUUID_device_owner, @EName, @CUUID1, NULL, NULL, NULL, NULL);
            FETCH NEXT FROM enters_cursor INTO @EName, @DName, @DVersion;
            END
    close enters_cursor;
    DEALLOCATE enters_cursor;


     /*
     TODO: Сгенерировать набор выходов
     */

    DECLARE @RName nvarchar(MAX);
    DECLARE @RDName nvarchar(MAX);
    DECLARE @RDVersion int;
    DECLARE enters_cursor cursor FOR SELECT RName, DName, DVersion FROM export_relays WHERE DName = @CDeviceName;
        OPEN enters_cursor;
        FETCH NEXT FROM enters_cursor INTO @RName, @RDName, @RDVersion;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                print @DName;
                SET @CUUID1 = (SELECT CUUID FROM dde_ConceptX WHERE CConcept = 3700 AND CName = @RName);
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                            VALUES (NEWID(), 20000200, @CUUID_device_owner, @RName, @CUUID1, NULL, NULL, NULL, NULL);
            FETCH NEXT FROM enters_cursor INTO @RName, @RDName, @RDVersion;
            END
    close enters_cursor;
    DEALLOCATE enters_cursor;

         /*
     TODO: Сгенерировать набор считывателей
     */

    DECLARE @RrName nvarchar(MAX);
    DECLARE @RrDName nvarchar(MAX);
    DECLARE @RrDVersion int;
    DECLARE enters_cursor cursor FOR SELECT RName, DName, DVersion FROM export_readers WHERE DName = @CDeviceName;
        OPEN enters_cursor;
        FETCH NEXT FROM enters_cursor INTO @RrName, @RrDName, @RrDVersion;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                print @DName;
                SET @CUUID1 = (SELECT CUUID FROM dde_ConceptX WHERE CConcept = 3800 AND CName = @RName);
                IF(@insertable = 1)
                    INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                            VALUES (NEWID(), 20000300, @CUUID_device_owner, @RrName, @CUUID1, NULL, NULL, NULL, NULL);
            FETCH NEXT FROM enters_cursor INTO @RrName, @RrDName, @RrDVersion;
            END
    close enters_cursor;
    DEALLOCATE enters_cursor;

/* ГЕНЕРАЦИЯ СОБЫТИЙ ПРИБОРОВ */
    DECLARE @EvName nvarchar(MAX);
    DECLARE @EvDName nvarchar(MAX);
    DECLARE @EvDVersion int;
    DECLARE enters_cursor cursor FOR SELECT EventName, DName, DVersion FROM export_devices_events WHERE DName = @CDeviceName;
        OPEN enters_cursor;
        FETCH NEXT FROM enters_cursor INTO @EvName, @EvDName, @EvDVersion;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                print @DName;
                SET @CUUID1 = (SELECT CUUID FROM dde_ConceptX WHERE CConcept = 4000 AND CName = @EvName);

                INSERT INTO dde_SetX (SUUID, SConcept, SOwner, SName, SUUID1, SUUID2, SUUID3, SInt1, SText1)
                        VALUES (NEWID(), @SConcept_EventsDevice_sets, @CUUID_device_owner, @EvName, @CUUID1, NULL, NULL, NULL, NULL);
            FETCH NEXT FROM enters_cursor INTO @EvName, @EvDName, @EvDVersion;
            END
    close enters_cursor;
    DEALLOCATE enters_cursor;

    -- print @CUUID_device_owner;
    FETCH NEXT FROM cuuid_cursor INTO @CUUID_device_owner, @CConcept_device, @CDeviceName;
   END;


IF((SELECT count(distinct SOwner) FROM dde_SetX WHERE SConcept = 20000400) < (SELECT count(CUUID) FROM dde_ConceptX WHERE CConcept BETWEEN 5000 and 50000))
print 'Error compare counting devices! Please, check your data.'
CLOSE cuuid_cursor;
DEALLOCATE cuuid_cursor;
--SELECT count(distinct SOwner) FROM dde_SetX WHERE SConcept = 20000400
--SELECT count(CUUID) FROM dde_ConceptX WHERE CConcept BETWEEN 5000 and 50000
-- SELECT distinct SOwner FROM dde_SetX WHERE SConcept = 20000400
/*
BEGIN
DECLARE @ElementITemType int;
SET @ElementITemType = 8;
SELECT
--        a.DeviceType,
        rl.GIndex,
       --DI.Name,
--        rl.Name,
       a.Name as enter
       ,t2.Name,
       t2.DeviceVersion
       --dTE.Name as device,

    FROM dTypesElement a
INNER JOIN DevItems DI on a.DeviceType = DI.GType
INNER JOIN RSLines rl ON DI.DeviceID = rl.GIndex
INNER JOIN (SELECT DeviceType, Name, DeviceVersion FROM dTypesElement WHERE ElementType = 4) t2 ON (t2.DeviceType) = rl.DeviceType
    AND t2.DeviceVersion = rl.DeviceVersion
    WHERE DI.ComputerID = 5
    AND a.ElementType = @ElementITemType-- id названий шлейфов в dTypesElement
    AND DI.ItemType = @ElementITemType  -- шлейф в DevItems
ORDER BY t2.Name, t2.DeviceVersion
END
*/
/*
 100	модификаций (записей в справочник прибора конкретного типа)
1000	типов приборов

Концепты нумеруются через 100, у каждого концепта может быть 99 записей с аккуратными UUID
Концепты во всех таблицах сквозные, не повторяются
Концепты экземпляров = концептам типов + 30 000 000
от	до
 100    	 	 19,999,900    	справочники разные
 20,000,000    	 29,999,900    	наборы на справочниках
 30,000,000    	 39,999,900    	экземпляры
 40,000,000    	 49,999,900    	наборы на экземплярах
 50,000,000    	 59,999,900    	структуры деревьев
 60,000,000    	 99,999,900    	остальные концепты (дизайн формы справочника, метки полей,…)
 100,000,000    		концепты, создаваемые пользователями (или UUID ?)

 */